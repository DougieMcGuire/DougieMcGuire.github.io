<!DOCTYPE html>
<html>
<head>
    <title>Random Marble Race</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        canvas {
            border: 2px solid #333;
            background: white;
            margin: 20px;
        }
        button {
            padding: 12px 24px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:disabled {
            background: #cccccc;
        }
        #result {
            font-size: 24px;
            margin: 20px;
            font-weight: bold;
        }
        #saveButton {
            background: #2196F3;
        }
    </style>
</head>
<body>
    <h1>Marble Race</h1>
    <canvas id="raceCanvas" width="800" height="400"></canvas>
    <button id="startRace">Start Random Marble Race</button>
    <button id="saveRace" disabled>Save Race</button>
    <div id="result"></div>

    <script>
        const canvas = document.getElementById('raceCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startRace');
        const saveButton = document.getElementById('saveRace');
        const resultDiv = document.getElementById('result');

        let marble1 = { x: 50, y: 100, speed: 0, color: 'red' };
        let marble2 = { x: 50, y: 300, speed: 0, color: 'blue' };
        let raceInProgress = false;
        let mediaRecorder;
        let recordedChunks = [];

        function resetMarbles() {
            marble1 = { x: 50, y: 100, speed: 0, color: 'red' };
            marble2 = { x: 50, y: 300, speed: 0, color: 'blue' };
            resultDiv.textContent = '';
            saveButton.disabled = true;
        }

        function drawMarble(marble) {
            ctx.beginPath();
            ctx.arc(marble.x, marble.y, 15, 0, Math.PI * 2);
            ctx.fillStyle = marble.color;
            ctx.fill();
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function drawTrack() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw finish line
            ctx.fillStyle = 'black';
            ctx.fillRect(700, 0, 5, canvas.height);
            
            // Draw lanes
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, 200);
            ctx.lineTo(canvas.width, 200);
            ctx.stroke();
        }

        function updateMarbles() {
            marble1.speed = marble1.speed + (Math.random() * 0.5 - 0.25);
            marble2.speed = marble2.speed + (Math.random() * 0.5 - 0.25);
            
            marble1.speed = Math.max(1, Math.min(marble1.speed, 5));
            marble2.speed = Math.max(1, Math.min(marble2.speed, 5));
            
            marble1.x += marble1.speed;
            marble2.x += marble2.speed;
        }

        function checkWinner() {
            if (marble1.x >= 700 || marble2.x >= 700) {
                raceInProgress = false;
                startButton.disabled = false;
                
                let winner = marble1.x > marble2.x ? "Red Marble" : "Blue Marble";
                resultDiv.textContent = `${winner} wins the race!`;
                
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                
                saveButton.disabled = false;
                return true;
            }
            return false;
        }

        function animate() {
            if (!raceInProgress) return;
            
            drawTrack();
            updateMarbles();
            drawMarble(marble1);
            drawMarble(marble2);
            
            if (!checkWinner()) {
                requestAnimationFrame(animate);
            }
        }

        function startRecording() {
            recordedChunks = [];
            const stream = canvas.captureStream(60);
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                saveButton.disabled = false;
            };

            mediaRecorder.start();
        }

        startButton.addEventListener('click', () => {
            resetMarbles();
            raceInProgress = true;
            startButton.disabled = true;
            startRecording();
            animate();
        });

        saveButton.addEventListener('click', () => {
            const blob = new Blob(recordedChunks, {
                type: 'video/webm'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'marble-race.webm';
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
