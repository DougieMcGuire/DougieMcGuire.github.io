<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Script Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        #loadingIndicator {
            display: none;
            margin-top: 10px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Generate a Video Script</h1>

    <label for="apiKey">Groq API Key:</label>
    <input type="password" id="apiKey" placeholder="Enter your Groq API key" required><br>

    <label for="topic">Topic:</label>
    <input type="text" id="topic" placeholder="Enter a topic" required><br>

    <label for="dimension">2D or 3D:</label>
    <select id="dimension">
        <option value="2D">2D</option>
        <option value="3D">3D</option>
    </select><br>

    <label for="style">Style:</label>
    <select id="style">
        <option value="Documentary">Documentary</option>
        <option value="Story">Story</option>
        <option value="Explaining">Explaining</option>
        <option value="Custom">Custom (Type Below)</option>
    </select><br>
    <input type="text" id="customStyle" placeholder="Custom Style (if selected)"><br>

    <label for="format">Shortform or Longform:</label>
    <select id="format">
        <option value="Shortform">Shortform</option>
        <option value="Longform">Longform</option>
    </select><br>

    <label for="details">Additional Details:</label>
    <input type="text" id="details" placeholder="Any extra details"><br>

    <label for="voice">Voice for TTS:</label>
    <input type="text" id="voice" placeholder="Enter a voice (e.g., en-US-AriaNeural)" value="en-US-AriaNeural"><br>

    <button id="generateButton" onclick="generateScript()">Generate</button>
    <div id="loadingIndicator">Processing... This may take a minute...</div>

    <h2>Generated Script:</h2>
    <pre id="scriptOutput">Script will appear here...</pre>

    <h2>Generated MP3:</h2>
    <audio id="audioPlayer" controls></audio>
    <div id="audioError" class="error"></div>

    <h2>Generated SRT:</h2>
    <pre id="srtOutput">Subtitles will appear here...</pre>

    <script>
        async function generateScript() {
            // Show loading indicator and clear previous results
            document.getElementById("loadingIndicator").style.display = "block";
            document.getElementById("scriptOutput").textContent = "Generating script...";
            document.getElementById("audioPlayer").src = "";
            document.getElementById("audioError").textContent = "";
            document.getElementById("srtOutput").textContent = "Waiting for audio generation...";
            
            // Disable the button while processing
            const generateButton = document.getElementById("generateButton");
            generateButton.disabled = true;
            
            // Get all form values
            const apiKey = document.getElementById("apiKey").value;
            const topic = document.getElementById("topic").value;
            const dimension = document.getElementById("dimension").value;
            let style = document.getElementById("style").value;
            const customStyle = document.getElementById("customStyle").value;
            const format = document.getElementById("format").value;
            const details = document.getElementById("details").value;
            const voice = document.getElementById("voice").value || "en-US-AriaNeural";

            if (!apiKey) {
                document.getElementById("scriptOutput").textContent = "Error: Please enter your Groq API key";
                document.getElementById("loadingIndicator").style.display = "none";
                generateButton.disabled = false;
                return;
            }

            if (!topic) {
                document.getElementById("scriptOutput").textContent = "Error: Please enter a topic";
                document.getElementById("loadingIndicator").style.display = "none";
                generateButton.disabled = false;
                return;
            }

            if (style === "Custom" && customStyle.trim() !== "") {
                style = customStyle;
            }

            try {
                // Step 1: Generate script using Groq API
                document.getElementById("scriptOutput").textContent = "Generating script with Groq...";
                
                // Using the correct Groq API URL from your curl example
                const groqResponse = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        "model": "llama-3.3-70b-versatile",
                        "messages": [{
                            "role": "user",
                            "content": `Generate me the most perfect YouTube ${format} video script about ${topic}. When I say video script, I mean just what the narrator should say. Do not send any extra text, do not converse with me. Whatever you send will be sent directly to a TTS model. ONLY put what the narrator should say, as if this will be read off every word you send. Be descriptive. Make this perfect for attention and engagement. It should be in this style: ${style}. ${details ? details : ""}`
                        }]
                    })
                });

                if (!groqResponse.ok) {
                    const errorData = await groqResponse.json();
                    throw new Error(`Groq API Error: ${errorData.error?.message || groqResponse.statusText}`);
                }

                const groqData = await groqResponse.json();
                const scriptText = groqData.choices?.[0]?.message?.content;
                
                if (!scriptText) {
                    throw new Error("Failed to generate script content");
                }

                document.getElementById("scriptOutput").textContent = scriptText;

                // Step 2: Send script to TTS API
                document.getElementById("srtOutput").textContent = "Generating audio...";
                
                const ttsResponse = await fetch("https://o-6sxb.onrender.com/generate-speech", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "text": scriptText,
                        "voice": voice
                    })
                });

                if (!ttsResponse.ok) {
                    throw new Error(`TTS API Error: ${ttsResponse.statusText}`);
                }

                const ttsData = await ttsResponse.json();
                const audioUrl = ttsData.audio_url;

                if (!audioUrl) {
                    throw new Error("Failed to generate audio URL");
                }

                document.getElementById("audioPlayer").src = audioUrl;

                // Step 3: Get SRT file from STT API
                document.getElementById("srtOutput").textContent = "Generating subtitles...";
                
                const audioBlob = await fetch(audioUrl).then(res => {
                    if (!res.ok) {
                        throw new Error("Failed to fetch audio file");
                    }
                    return res.blob();
                });
                
                const formData = new FormData();
                formData.append("file", audioBlob, "audio.mp3");

                const sttResponse = await fetch("https://stt-ym3y.onrender.com/convert", {
                    method: "POST",
                    body: formData
                });

                if (!sttResponse.ok) {
                    throw new Error(`STT API Error: ${sttResponse.statusText}`);
                }

                const srtData = await sttResponse.json();
                const srtText = srtData.srt;

                if (!srtText) {
                    throw new Error("Failed to generate subtitles");
                }

                document.getElementById("srtOutput").textContent = srtText;
                
            } catch (error) {
                console.error("Error:", error);
                
                if (error.message.includes("Groq API")) {
                    document.getElementById("scriptOutput").textContent = `Error: ${error.message}`;
                } else if (error.message.includes("TTS API")) {
                    document.getElementById("audioError").textContent = `Error: ${error.message}`;
                    document.getElementById("srtOutput").textContent = "Subtitles generation failed: Audio could not be generated";
                } else if (error.message.includes("STT API")) {
                    document.getElementById("srtOutput").textContent = `Error: ${error.message}`;
                } else {
                    document.getElementById("scriptOutput").textContent = `Error: ${error.message}`;
                }
            } finally {
                // Hide loading indicator and re-enable button
                document.getElementById("loadingIndicator").style.display = "none";
                generateButton.disabled = false;
            }
        }
    </script>
</body>
</html>
