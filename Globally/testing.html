<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="chat-modules.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f4f4f4;
    }
    #app {
      max-width: 600px;
      width: 100%;
      margin-top: 20px;
      background: #fff;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 8px;
    }
    .section {
      margin-bottom: 20px;
    }
    .friend-request {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #messageInput {
      width: calc(100% - 50px);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 10px;
      background: #f9f9f9;
      margin-bottom: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    li:hover {
      background: #e9e9e9;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="authSection" class="section">
      <h2>Authentication</h2>
      <div id="authForms">
        <input type="text" id="signupEmail" placeholder="Email">
        <input type="password" id="signupPassword" placeholder="Password">
        <input type="text" id="signupUsername" placeholder="Username">
        <button onclick="signUp()">Sign Up</button>
        <br>
        <input type="text" id="signinEmail" placeholder="Email">
        <input type="password" id="signinPassword" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
      </div>
    </div>

    <div id="userSection" class="section" style="display: none;">
      <h2>Welcome</h2>
      <div id="currentUserDisplay"></div>
      <button onclick="signOut()">Sign Out</button>
    </div>

    <div id="friendSection" class="section" style="display: none;">
      <h2>Friends</h2>
      <input type="text" id="friendUsername" placeholder="Friend's Username">
      <button onclick="sendFriendRequest()">Add Friend</button>
      <h3>Friend Requests</h3>
      <ul id="friendRequests"></ul>
      <h3>Your Friends</h3>
      <ul id="friendList"></ul>
    </div>

    <div id="chatSection" class="section" style="display: none;">
      <h2>Chat</h2>
      <h3 id="chatWith">Chatting with: None</h3>
      <div id="messages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; padding: 10px;"></div>
      <input type="text" id="messageInput" placeholder="Type a message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    // Initialize App
    ChatModule.initialize();

    // Global variables for current user and UI elements
    let currentFriend = null;

    // Sign Up function
    async function signUp() {
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const username = document.getElementById("signupUsername").value;
      await ChatModule.signUp(email, password, username);
    }

    // Sign In function
    async function signIn() {
      const email = document.getElementById("signinEmail").value;
      const password = document.getElementById("signinPassword").value;
      const user = await ChatModule.signIn(email, password);
      if (user) {
        displayUserSection(user);
        loadFriendData();
      }
    }

    // Sign Out function
    function signOut() {
      ChatModule.signOut();
      location.reload();
    }

    // Display user section after sign in
    function displayUserSection(user) {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("userSection").style.display = "block";
      document.getElementById("friendSection").style.display = "block";
      document.getElementById("chatSection").style.display = "block";
      document.getElementById("currentUserDisplay").innerText = `Logged in as: ${user.displayName}`;
    }

    // Send a message
    function sendMessage() {
      const message = document.getElementById("messageInput").value;
      if (message && currentFriend) {
        ChatModule.sendMessage(message);
        document.getElementById("messageInput").value = "";
      }
    }

    // Load friend data
    async function loadFriendData() {
      ChatModule.listenForFriendRequests((requests) => {
        const requestList = document.getElementById("friendRequests");
        requestList.innerHTML = "";
        for (const id in requests) {
          const { from } = requests[id];
          const li = document.createElement("li");
          li.className = "friend-request";
          li.innerHTML = `${from} 
            <button onclick="acceptFriendRequest('${id}')">Accept</button>
            <button onclick="denyFriendRequest('${id}')">Deny</button>`;
          requestList.appendChild(li);
        }
      });

      ChatModule.listenForFriends((friends) => {
        const friendList = document.getElementById("friendList");
        friendList.innerHTML = "";
        for (const id in friends) {
          const li = document.createElement("li");
          li.textContent = friends[id];
          li.onclick = () => selectChat(id, friends[id]);
          friendList.appendChild(li);
        }
      });
    }

    // Accept friend request
    function acceptFriendRequest(id) {
      ChatModule.handleFriendRequest(id, true);
    }

    // Deny friend request
    function denyFriendRequest(id) {
      ChatModule.handleFriendRequest(id, false);
    }

    // Select a chat
    function selectChat(friendId, friendName) {
      currentFriend = friendId;
      ChatModule.selectChat(friendId);
      document.getElementById("chatWith").innerText = `Chatting with: ${friendName}`;
      loadMessages();
    }

    // Load messages for current chat
    function loadMessages() {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      ChatModule.listenForMessages((messageData) => {
        const messageDiv = document.createElement("div");
        messageDiv.innerText = `${messageData.from}: ${messageData.message}`;
        messagesDiv.appendChild(messageDiv);
      });
    }
  </script>
</body>
</html>
