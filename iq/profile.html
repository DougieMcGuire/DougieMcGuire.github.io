<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Profile | IQ Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared.css">
  <style>
    /* ─── PROFILE PAGE SPECIFIC ─── */
    .profile-scroll {
      flex: 1; 
      overflow-y: auto;
      display: flex; 
      flex-direction: column;
      align-items: center;
      padding: 32px 24px 60px;
    }

    .profile-topbar {
      width: 100%; 
      max-width: 540px;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 22px;
    }
    
    .share-btn {
      background: var(--card);
      border: 2px solid var(--tan-dark);
      border-radius: 40px;
      padding: 8px 18px;
      font-family: 'Patrick Hand', cursive;
      font-size: 13px; 
      color: var(--ink);
      cursor: pointer;
      display: flex; 
      align-items: center; 
      gap: 7px;
      transition: all 0.15s;
    }
    .share-btn:hover { 
      background: var(--tan-dark); 
      color: #fff; 
      transform: scale(1.03); 
    }
    .share-btn svg {
      width: 14px; height: 14px;
      stroke: currentColor; fill: none;
      stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round;
    }

    /* Avatar */
    .avatar-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .avatar-ring {
      width: 112px; height: 112px;
      border-radius: 50%;
      background: var(--card);
      border: 4px solid var(--tan-dark);
      box-shadow: 0 4px 22px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex; 
      align-items: center; 
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .avatar-ring:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 28px rgba(0,0,0,0.15);
    }
    .avatar-ring img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
    }
    .avatar-icon {
      width: 56px; height: 56px;
      stroke: var(--tan-darker); fill: none;
      stroke-width: 1.6; stroke-linecap: round; stroke-linejoin: round;
    }
    
    .avatar-edit {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 32px;
      height: 32px;
      background: var(--ink);
      border: 2px solid var(--card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .avatar-edit svg {
      width: 14px;
      height: 14px;
      stroke: #fff;
      fill: none;
      stroke-width: 2;
    }
    
    .avatar-input {
      display: none;
    }

    /* IQ */
    .iq-number {
      font-family: 'Verdana', 'Geneva', sans-serif;
      font-size: 84px; 
      font-weight: 700;
      color: var(--ink); 
      line-height: 1; 
      letter-spacing: -2px;
    }
    .iq-label {
      font-family: 'Verdana', 'Geneva', sans-serif;
      font-size: 17px; 
      color: var(--ink-light);
      letter-spacing: 5px; 
      margin-top: 2px;
    }

    /* Percentile */
    .pct-tag {
      margin-top: 12px;
      background: var(--tan-darker); 
      color: #F5EDD8;
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      padding: 5px 18px; 
      border-radius: 20px;
      letter-spacing: 0.4px;
    }

    /* Session stats */
    .session-stats {
      margin-top: 16px;
      display: flex;
      gap: 24px;
    }
    .session-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .session-val {
      font-family: 'Verdana', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--ink);
    }
    .session-label {
      font-family: 'Patrick Hand', cursive;
      font-size: 11px;
      color: var(--ink-light);
      letter-spacing: 0.5px;
    }

    .section-divider {
      width: 55%; 
      height: 1.5px;
      background: linear-gradient(90deg, transparent, var(--tan-dark), transparent);
      margin: 24px 0 22px;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: 100%; 
      max-width: 540px;
    }
    .stat-card {
      background: var(--card);
      border: 1.5px solid var(--tan-dark);
      border-radius: var(--radius);
      padding: 12px 14px;
      display: flex; 
      flex-direction: column; 
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 18px rgba(0,0,0,0.07); 
    }

    .stat-name {
      font-family: 'Nunito', sans-serif;
      font-size: 11px; 
      font-weight: 800;
      color: var(--ink-light);
      text-transform: uppercase; 
      letter-spacing: 0.9px;
    }
    .stat-bar-wrap {
      background: var(--bar-bg);
      border-radius: 8px; 
      height: 30px; 
      overflow: hidden;
    }
    .stat-bar {
      height: 100%; 
      border-radius: 8px;
      display: flex; 
      align-items: center; 
      padding-left: 10px;
      width: 0%;
      transition: width 0.9s cubic-bezier(.23,1,.32,1);
    }
    .stat-val {
      font-family: 'Verdana', 'Geneva', sans-serif;
      font-size: 15px; 
      font-weight: 700;
      color: #fff; 
      text-shadow: 0 1px 3px rgba(0,0,0,0.22);
    }

    /* Reset button */
    .reset-btn {
      margin-top: 32px;
      background: none;
      border: 1px solid var(--tan-dark);
      border-radius: 20px;
      padding: 8px 20px;
      font-family: 'Patrick Hand', cursive;
      font-size: 12px;
      color: var(--ink-light);
      cursor: pointer;
      transition: all 0.15s;
    }
    .reset-btn:hover {
      background: var(--red);
      border-color: var(--red);
      color: #fff;
    }

    /* Share modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg);
      border-radius: 24px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
    }
    .modal-close svg {
      width: 20px;
      height: 20px;
      stroke: var(--ink-light);
      stroke-width: 2;
    }
    
    .share-preview {
      background: var(--card);
      border: 2px solid var(--tan-dark);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }
    
    .share-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .share-action-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--tan-dark);
      border-radius: 12px;
      background: var(--card);
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      color: var(--ink);
      cursor: pointer;
      transition: all 0.15s;
    }
    .share-action-btn:hover {
      background: var(--tan-dark);
      color: #fff;
    }
    .share-action-btn.primary {
      background: var(--ink);
      color: #fff;
      border-color: var(--ink);
    }
  </style>
</head>
<body>

  <!-- DOODLE BG -->
  <div class="doodle-bg">
    <svg style="left:6%;top:6%;width:140px;height:140px;" viewBox="0 0 100 100">
      <path d="M50 80 C30 80 15 65 15 50 C15 35 28 28 38 30 C40 20 50 15 60 20 C70 10 85 18 85 32 C92 36 90 50 82 55 C80 68 65 80 50 80Z"/>
    </svg>
    <svg style="right:8%;top:10%;width:100px;height:110px;" viewBox="0 0 80 90">
      <circle cx="40" cy="32" r="16"/>
      <path d="M32 48 L32 56 Q32 60 40 60 Q48 60 48 56 L48 48"/>
    </svg>
    <svg style="right:4%;top:48%;width:90px;height:90px;" viewBox="0 0 80 80">
      <path d="M10 10 L35 10 C35 10 33 15 33 20 C33 25 38 25 40 20 C42 15 40 10 40 10 L65 10 L65 35 C65 35 60 33 55 33 C50 33 50 38 55 40 C60 42 65 40 65 40 L65 65 L40 65 C40 65 42 60 40 55 C38 50 33 50 33 55 C33 60 35 65 35 65 L10 65 L10 40 C10 40 15 42 20 40 C25 38 25 33 20 33 C15 33 10 35 10 35Z"/>
    </svg>
    <svg style="left:55%;top:3%;width:60px;height:60px;" viewBox="0 0 56 56">
      <polygon points="28,4 31,19 46,19 34,28 38,43 28,33 18,43 22,28 10,19 25,19"/>
    </svg>
  </div>

  <!-- NAV -->
  <nav>
    <a class="nav-btn" href="improve.html">
      <svg viewBox="0 0 24 24">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
        <polyline points="17 6 23 6 23 12"/>
      </svg>
      Improve
    </a>
    <div class="nav-divider"></div>
    <a class="nav-btn active" href="profile.html">
      <svg viewBox="0 0 24 24">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Profile
    </a>
  </nav>

  <!-- APP -->
  <div id="app">
    <div class="profile-scroll">

      <div class="profile-topbar a0">
        <button class="share-btn" onclick="openShareModal()">
          <svg viewBox="0 0 24 24">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
          Share Stats
        </button>
      </div>

      <div class="avatar-container a0">
        <div class="avatar-ring" onclick="document.getElementById('avatar-input').click()">
          <img id="avatar-img" src="" alt="Profile" style="display:none;">
          <svg id="avatar-placeholder" class="avatar-icon" viewBox="0 0 64 64">
            <circle cx="32" cy="22" r="12"/>
            <path d="M8 58 C8 44 18 36 32 36 C46 36 56 44 56 58"/>
          </svg>
        </div>
        <div class="avatar-edit" onclick="document.getElementById('avatar-input').click()">
          <svg viewBox="0 0 24 24">
            <path d="M12 20h9"/>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
          </svg>
        </div>
        <input type="file" id="avatar-input" class="avatar-input" accept="image/*" onchange="handleAvatarUpload(this)">
      </div>

      <div class="iq-number a1" id="iq-display">80</div>
      <div class="iq-label a1">IQ</div>
      <div class="pct-tag a2" id="pct-tag"></div>

      <div class="session-stats a2">
        <div class="session-stat">
          <span class="session-val" id="total-answered">0</span>
          <span class="session-label">Answered</span>
        </div>
        <div class="session-stat">
          <span class="session-val" id="accuracy">0%</span>
          <span class="session-label">Accuracy</span>
        </div>
      </div>

      <div class="section-divider"></div>

      <div class="stats-grid" id="stats-grid">
        <!-- Generated by JS -->
      </div>

      <button class="reset-btn" onclick="confirmReset()">Reset All Progress</button>

    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal-overlay" id="share-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeShareModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      
      <div class="share-preview" id="share-preview">
        <!-- Generated canvas will go here -->
      </div>
      
      <div class="share-actions">
        <button class="share-action-btn" onclick="copyShareImage()">Copy Image</button>
        <button class="share-action-btn primary" onclick="downloadShareImage()">Download</button>
      </div>
    </div>
  </div>

  <script src="data.js"></script>
  <script>
    // Load and display profile
    function loadProfile() {
      const data = IQData.load();
      
      // IQ and percentile
      document.getElementById('iq-display').textContent = data.iq;
      const pct = iqToPercentile(data.iq);
      document.getElementById('pct-tag').textContent = 'Top ' + formatPercentile(pct) + ' in the world';
      
      // Total stats
      let totalCorrect = 0;
      let totalQuestions = 0;
      for (const cat in data.stats) {
        totalCorrect += data.stats[cat].correct;
        totalQuestions += data.stats[cat].total;
      }
      document.getElementById('total-answered').textContent = totalQuestions;
      document.getElementById('accuracy').textContent = totalQuestions > 0 
        ? Math.round((totalCorrect / totalQuestions) * 100) + '%' 
        : '0%';
      
      // Profile pic
      if (data.profilePic) {
        document.getElementById('avatar-img').src = data.profilePic;
        document.getElementById('avatar-img').style.display = 'block';
        document.getElementById('avatar-placeholder').style.display = 'none';
      }
      
      // Stats bars
      const statsGrid = document.getElementById('stats-grid');
      statsGrid.innerHTML = '';
      
      const categoryOrder = ['problemSolving', 'memory', 'patternRecognition', 'commonSense', 'mentalAgility', 'emotionalIntelligence'];
      
      for (const cat of categoryOrder) {
        const info = CATEGORIES[cat];
        const percent = IQData.getStatPercent(cat);
        
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-name">${info.name}</div>
          <div class="stat-bar-wrap">
            <div class="stat-bar bar-${info.cssClass}" data-val="${percent}">
              <span class="stat-val">${percent}</span>
            </div>
          </div>
        `;
        statsGrid.appendChild(card);
      }
      
      // Animate bars
      setTimeout(animateBars, 100);
    }
    
    function animateBars() {
      document.querySelectorAll('.stat-bar').forEach(bar => {
        bar.style.width = '0%';
        requestAnimationFrame(() => setTimeout(() => {
          bar.style.width = Math.max(15, parseInt(bar.dataset.val)) + '%';
        }, 50));
      });
    }
    
    // Avatar upload
    function handleAvatarUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        // Resize image
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const size = 256;
          canvas.width = size;
          canvas.height = size;
          
          const ctx = canvas.getContext('2d');
          const minDim = Math.min(img.width, img.height);
          const sx = (img.width - minDim) / 2;
          const sy = (img.height - minDim) / 2;
          
          ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
          
          const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
          IQData.setProfilePic(dataUrl);
          
          document.getElementById('avatar-img').src = dataUrl;
          document.getElementById('avatar-img').style.display = 'block';
          document.getElementById('avatar-placeholder').style.display = 'none';
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // Share functionality
    let shareCanvas = null;
    
    function openShareModal() {
      const modal = document.getElementById('share-modal');
      modal.classList.add('show');
      generateShareImage();
    }
    
    function closeShareModal() {
      document.getElementById('share-modal').classList.remove('show');
    }
    
    function generateShareImage() {
      const data = IQData.load();
      const preview = document.getElementById('share-preview');
      
      // Create canvas
      const canvas = document.createElement('canvas');
      canvas.width = 600;
      canvas.height = 700;
      const ctx = canvas.getContext('2d');
      
      // Background
      ctx.fillStyle = '#F2EBD9';
      ctx.fillRect(0, 0, 600, 700);
      
      // Card background
      ctx.fillStyle = '#EDE5CF';
      roundRect(ctx, 30, 30, 540, 640, 24);
      ctx.fill();
      
      // Border
      ctx.strokeStyle = '#C4AD8A';
      ctx.lineWidth = 3;
      roundRect(ctx, 30, 30, 540, 640, 24);
      ctx.stroke();
      
      // Title
      ctx.font = '700 32px Nunito, sans-serif';
      ctx.fillStyle = '#2A2018';
      ctx.textAlign = 'center';
      ctx.fillText('IQ Profile', 300, 80);
      
      // IQ Score
      ctx.font = '700 96px Verdana, sans-serif';
      ctx.fillText(data.iq.toString(), 300, 190);
      
      ctx.font = '600 18px Verdana, sans-serif';
      ctx.fillStyle = '#6B5740';
      ctx.letterSpacing = '4px';
      ctx.fillText('IQ', 300, 220);
      
      // Percentile
      const pct = iqToPercentile(data.iq);
      ctx.font = '400 16px Patrick Hand, cursive';
      ctx.fillStyle = '#A08C6E';
      ctx.fillText('Top ' + formatPercentile(pct) + ' in the world', 300, 255);
      
      // Stats
      const stats = [
        { name: 'Problem Solving', color: '#D96A28', val: IQData.getStatPercent('problemSolving') },
        { name: 'Memory', color: '#8A5BAF', val: IQData.getStatPercent('memory') },
        { name: 'Pattern Recognition', color: '#C43820', val: IQData.getStatPercent('patternRecognition') },
        { name: 'Common Sense', color: '#2A96B8', val: IQData.getStatPercent('commonSense') },
        { name: 'Mental Agility', color: '#4AAA4A', val: IQData.getStatPercent('mentalAgility') },
        { name: 'Emotional Intel.', color: '#C44878', val: IQData.getStatPercent('emotionalIntelligence') }
      ];
      
      let y = 300;
      stats.forEach(stat => {
        // Label
        ctx.font = '700 12px Nunito, sans-serif';
        ctx.fillStyle = '#6B5740';
        ctx.textAlign = 'left';
        ctx.fillText(stat.name.toUpperCase(), 60, y);
        
        // Bar background
        ctx.fillStyle = '#D5C8AD';
        roundRect(ctx, 60, y + 8, 480, 28, 8);
        ctx.fill();
        
        // Bar fill
        ctx.fillStyle = stat.color;
        const barWidth = Math.max(40, (stat.val / 100) * 480);
        roundRect(ctx, 60, y + 8, barWidth, 28, 8);
        ctx.fill();
        
        // Value
        ctx.font = '700 14px Verdana, sans-serif';
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'left';
        ctx.fillText(stat.val.toString(), 72, y + 27);
        
        y += 55;
      });
      
      // Footer
      ctx.font = '400 14px Patrick Hand, cursive';
      ctx.fillStyle = '#A08C6E';
      ctx.textAlign = 'center';
      ctx.fillText('iqprofile.app', 300, 660);
      
      shareCanvas = canvas;
      
      // Show preview
      preview.innerHTML = '';
      canvas.style.width = '100%';
      canvas.style.height = 'auto';
      canvas.style.borderRadius = '12px';
      preview.appendChild(canvas);
    }
    
    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }
    
    async function copyShareImage() {
      if (!shareCanvas) return;
      
      try {
        const blob = await new Promise(resolve => shareCanvas.toBlob(resolve, 'image/png'));
        await navigator.clipboard.write([
          new ClipboardItem({ 'image/png': blob })
        ]);
        alert('Image copied to clipboard!');
      } catch (e) {
        console.error('Copy failed:', e);
        alert('Copy failed. Try downloading instead.');
      }
    }
    
    function downloadShareImage() {
      if (!shareCanvas) return;
      
      const link = document.createElement('a');
      link.download = 'my-iq-profile.png';
      link.href = shareCanvas.toDataURL('image/png');
      link.click();
    }
    
    // Reset
    function confirmReset() {
      if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
        IQData.reset();
        loadProfile();
      }
    }
    
    // Close modal on outside click
    document.getElementById('share-modal').addEventListener('click', (e) => {
      if (e.target.id === 'share-modal') closeShareModal();
    });
    
    // Init
    loadProfile();
  </script>
</body>
</html>