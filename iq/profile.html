<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Profile | IQ Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared.css">
  <style>
    .profile-scroll {
      flex: 1; 
      overflow-y: auto;
      display: flex; 
      flex-direction: column;
      align-items: center;
      padding: 20px 20px 40px;
    }

    .profile-header {
      width: 100%;
      max-width: 500px;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    .avatar-container {
      position: relative;
      margin-bottom: 12px;
    }
    
    .avatar-ring {
      width: 100px; height: 100px;
      border-radius: 50%;
      background: var(--card);
      border: 4px solid var(--tan-dark);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex; 
      align-items: center; 
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .avatar-ring:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(0,0,0,0.15);
    }
    .avatar-ring img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
    }
    .avatar-icon {
      width: 48px; height: 48px;
      stroke: var(--tan-darker); fill: none;
      stroke-width: 1.6;
    }
    
    .avatar-edit {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 30px;
      height: 30px;
      background: var(--ink);
      border: 2px solid var(--card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .avatar-edit:hover { transform: scale(1.1); }
    .avatar-edit svg {
      width: 12px;
      height: 12px;
      stroke: #fff;
      fill: none;
      stroke-width: 2;
    }
    
    .avatar-input { display: none; }

    .iq-section {
      text-align: center;
      margin-bottom: 8px;
    }

    .iq-number {
      font-family: 'Verdana', sans-serif;
      font-size: 72px; 
      font-weight: 700;
      color: var(--ink); 
      line-height: 1; 
      letter-spacing: -2px;
    }
    .iq-number.calculating {
      font-size: 24px;
      color: var(--ink-light);
    }
    .iq-label {
      font-family: 'Patrick Hand', cursive;
      font-size: 14px; 
      color: var(--ink-light);
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-top: 4px;
    }

    .pct-tag {
      margin-top: 8px;
      background: var(--tan-darker); 
      color: #F5EDD8;
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      padding: 5px 16px; 
      border-radius: 20px;
      display: inline-block;
    }

    .quick-stats {
      display: flex;
      gap: 20px;
      margin-top: 14px;
      padding: 12px 24px;
      background: var(--card);
      border-radius: 16px;
      border: 1.5px solid var(--tan-dark);
    }
    .quick-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .quick-stat-val {
      font-family: 'Verdana', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--ink);
    }
    .quick-stat-label {
      font-family: 'Patrick Hand', cursive;
      font-size: 11px;
      color: var(--ink-light);
    }

    .section-title {
      font-family: 'Patrick Hand', cursive;
      font-size: 16px;
      color: var(--ink-light);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 20px 0 12px;
      width: 100%;
      max-width: 500px;
      text-align: left;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      width: 100%; 
      max-width: 500px;
    }
    .stat-card {
      background: var(--card);
      border: 1.5px solid var(--tan-dark);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex; 
      flex-direction: column; 
      gap: 6px;
      transition: transform 0.2s;
    }
    .stat-card:active { transform: scale(0.98); }

    .stat-name {
      font-family: 'Nunito', sans-serif;
      font-size: 10px; 
      font-weight: 800;
      color: var(--ink-light);
      text-transform: uppercase; 
      letter-spacing: 0.7px;
    }
    .stat-bar-wrap {
      background: var(--bar-bg);
      border-radius: 6px; 
      height: 26px; 
      overflow: hidden;
    }
    .stat-bar {
      height: 100%; 
      border-radius: 6px;
      display: flex; 
      align-items: center; 
      padding-left: 8px;
      min-width: 30px;
      width: 0%;
      transition: width 0.8s cubic-bezier(.23,1,.32,1);
    }
    .stat-val {
      font-family: 'Verdana', sans-serif;
      font-size: 13px; 
      font-weight: 700;
      color: #fff; 
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      width: 100%;
      max-width: 500px;
    }
    .action-buttons .btn {
      flex: 1;
      justify-content: center;
    }

    .reset-btn {
      margin-top: 20px;
      background: none;
      border: none;
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      color: var(--ink-light);
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s, color 0.2s;
    }
    .reset-btn:hover {
      opacity: 1;
      color: var(--red);
    }

    .share-preview {
      background: var(--card);
      border: 2px solid var(--tan-dark);
      border-radius: 16px;
      overflow: hidden;
    }
    .share-preview canvas {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .share-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .share-actions .btn {
      flex: 1;
      justify-content: center;
    }

    @media (max-width: 400px) {
      .iq-number { font-size: 60px; }
      .quick-stats { gap: 16px; padding: 10px 18px; }
      .quick-stat-val { font-size: 18px; }
      .stats-grid { gap: 8px; }
      .stat-card { padding: 8px 10px; }
    }
  </style>
</head>
<body>

<div class="doodle-bg">
  <svg style="left:5%;top:8%;width:120px;height:120px;" viewBox="0 0 100 100">
    <path d="M50 80 C30 80 15 65 15 50 C15 35 28 28 38 30 C40 20 50 15 60 20 C70 10 85 18 85 32 C92 36 90 50 82 55 C80 68 65 80 50 80Z"/>
  </svg>
  <svg style="right:6%;top:12%;width:80px;height:90px;" viewBox="0 0 80 90">
    <circle cx="40" cy="32" r="16"/>
    <path d="M32 48 L32 56 Q32 60 40 60 Q48 60 48 56 L48 48"/>
  </svg>
  <svg style="right:4%;bottom:30%;width:70px;height:70px;" viewBox="0 0 80 80">
    <path d="M10 10 L35 10 C35 10 33 15 33 20 C33 25 38 25 40 20 C42 15 40 10 40 10 L65 10 L65 35"/>
  </svg>
</div>

<nav>
  <a class="nav-btn" href="improve.html">
    <svg viewBox="0 0 24 24">
      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
      <polyline points="17 6 23 6 23 12"/>
    </svg>
    Improve
  </a>
  <div class="nav-divider"></div>
  <a class="nav-btn active" href="profile.html">
    <svg viewBox="0 0 24 24">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
      <circle cx="12" cy="7" r="4"/>
    </svg>
    Profile
  </a>
</nav>

<div id="app">
  <div class="profile-scroll">

    <div class="profile-header a0">
      <button class="btn" onclick="openShareModal()">
        <svg viewBox="0 0 24 24">
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
          <polyline points="16 6 12 2 8 6"/>
          <line x1="12" y1="2" x2="12" y2="15"/>
        </svg>
        Share
      </button>
    </div>

    <div class="avatar-container a0">
      <div class="avatar-ring" onclick="document.getElementById('avatar-input').click()">
        <img id="avatar-img" src="" alt="Profile" style="display:none;">
        <svg id="avatar-placeholder" class="avatar-icon" viewBox="0 0 64 64">
          <circle cx="32" cy="22" r="12"/>
          <path d="M8 58 C8 44 18 36 32 36 C46 36 56 44 56 58"/>
        </svg>
      </div>
      <div class="avatar-edit" onclick="document.getElementById('avatar-input').click()">
        <svg viewBox="0 0 24 24">
          <path d="M12 20h9"/>
          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
        </svg>
      </div>
      <input type="file" id="avatar-input" class="avatar-input" accept="image/*" onchange="handleAvatarUpload(this)">
    </div>

    <div class="iq-section a1">
      <div class="iq-number" id="iq-display">--</div>
      <div class="iq-label" id="iq-label">IQ</div>
    </div>
    
    <div class="pct-tag a1" id="pct-tag"></div>

    <div class="quick-stats a2">
      <div class="quick-stat">
        <span class="quick-stat-val" id="total-answered">0</span>
        <span class="quick-stat-label">Answered</span>
      </div>
      <div class="quick-stat">
        <span class="quick-stat-val" id="accuracy">0%</span>
        <span class="quick-stat-label">Accuracy</span>
      </div>
      <div class="quick-stat">
        <span class="quick-stat-val" id="best-streak">0</span>
        <span class="quick-stat-label">Best ðŸ”¥</span>
      </div>
    </div>

    <div class="section-title a3">Abilities</div>

    <div class="stats-grid a3" id="stats-grid"></div>

    <button class="reset-btn" onclick="confirmReset()">Reset Progress</button>

  </div>
</div>

<!-- Share Modal -->
<div class="modal-overlay" id="share-modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeShareModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    
    <div class="modal-title">Share Your Stats</div>
    
    <div class="share-preview" id="share-preview"></div>
    
    <div class="share-actions">
      <button class="btn" onclick="copyShareImage()">
        <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        Copy
      </button>
      <button class="btn primary" onclick="downloadShareImage()">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download
      </button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="data.js"></script>
<script>
function loadProfile() {
  const data = IQData.load();
  
  // IQ
  const iqEl = document.getElementById('iq-display');
  const labelEl = document.getElementById('iq-label');
  if (data.iq) {
    iqEl.textContent = data.iq;
    iqEl.classList.remove('calculating');
    labelEl.textContent = getIQLabel(data.iq);
  } else {
    iqEl.textContent = 'Answer more questions';
    iqEl.classList.add('calculating');
    labelEl.textContent = 'to calculate IQ';
  }
  
  // Percentile
  const pctEl = document.getElementById('pct-tag');
  if (data.iq) {
    const pct = iqToPercentile(data.iq);
    pctEl.textContent = 'Top ' + formatPercentile(pct);
    pctEl.style.display = 'inline-block';
  } else {
    pctEl.style.display = 'none';
  }
  
  // Quick stats
  document.getElementById('total-answered').textContent = data.questionsAnswered;
  document.getElementById('accuracy').textContent = IQData.getAccuracy() + '%';
  document.getElementById('best-streak').textContent = data.bestStreak;
  
  // Profile pic
  if (data.profilePic) {
    document.getElementById('avatar-img').src = data.profilePic;
    document.getElementById('avatar-img').style.display = 'block';
    document.getElementById('avatar-placeholder').style.display = 'none';
  }
  
  // Stats bars
  const statsGrid = document.getElementById('stats-grid');
  statsGrid.innerHTML = '';
  
  const categoryOrder = ['patternRecognition', 'problemSolving', 'mentalAgility', 'memory', 'verbalReasoning', 'spatialAwareness', 'commonSense', 'emotionalIntelligence'];
  
  for (const cat of categoryOrder) {
    const info = CATEGORIES[cat];
    if (!info) continue;
    const percent = IQData.getStatPercent(cat);
    
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <div class="stat-name">${info.name}</div>
      <div class="stat-bar-wrap">
        <div class="stat-bar bar-${info.cssClass}" data-val="${percent}">
          <span class="stat-val">${percent}</span>
        </div>
      </div>
    `;
    statsGrid.appendChild(card);
  }
  
  setTimeout(animateBars, 150);
}

function animateBars() {
  document.querySelectorAll('.stat-bar').forEach(bar => {
    bar.style.width = '0%';
    requestAnimationFrame(() => setTimeout(() => {
      const val = parseInt(bar.dataset.val);
      bar.style.width = Math.max(18, val) + '%';
    }, 50));
  });
}

function handleAvatarUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const size = 256;
      canvas.width = size;
      canvas.height = size;
      
      const ctx = canvas.getContext('2d');
      const minDim = Math.min(img.width, img.height);
      const sx = (img.width - minDim) / 2;
      const sy = (img.height - minDim) / 2;
      
      ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
      
      const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
      IQData.setProfilePic(dataUrl);
      
      document.getElementById('avatar-img').src = dataUrl;
      document.getElementById('avatar-img').style.display = 'block';
      document.getElementById('avatar-placeholder').style.display = 'none';
      
      showToast('Profile photo updated!');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

let shareCanvas = null;

function openShareModal() {
  document.getElementById('share-modal').classList.add('show');
  generateShareImage();
}

function closeShareModal() {
  document.getElementById('share-modal').classList.remove('show');
}

function generateShareImage() {
  const data = IQData.load();
  const preview = document.getElementById('share-preview');
  
  const canvas = document.createElement('canvas');
  canvas.width = 540;
  canvas.height = 720;
  const ctx = canvas.getContext('2d');
  
  // Background
  ctx.fillStyle = '#F2EBD9';
  ctx.fillRect(0, 0, 540, 720);
  
  // Card
  ctx.fillStyle = '#EDE5CF';
  roundRect(ctx, 24, 24, 492, 672, 24);
  ctx.fill();
  ctx.strokeStyle = '#C4AD8A';
  ctx.lineWidth = 3;
  roundRect(ctx, 24, 24, 492, 672, 24);
  ctx.stroke();
  
  // Profile pic
  if (data.profilePic) {
    const img = new Image();
    img.onload = () => {
      ctx.save();
      ctx.beginPath();
      ctx.arc(270, 90, 45, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(img, 225, 45, 90, 90);
      ctx.restore();
      
      ctx.strokeStyle = '#C4AD8A';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(270, 90, 45, 0, Math.PI * 2);
      ctx.stroke();
      
      finishShareImage(ctx, data, canvas, preview);
    };
    img.src = data.profilePic;
  } else {
    // Default avatar circle
    ctx.fillStyle = '#D5C8AD';
    ctx.beginPath();
    ctx.arc(270, 90, 45, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#C4AD8A';
    ctx.lineWidth = 3;
    ctx.stroke();
    
    finishShareImage(ctx, data, canvas, preview);
  }
}

function finishShareImage(ctx, data, canvas, preview) {
  // IQ
  ctx.font = '700 72px Verdana, sans-serif';
  ctx.fillStyle = '#2A2018';
  ctx.textAlign = 'center';
  ctx.fillText(data.iq || '--', 270, 200);
  
  ctx.font = '400 14px Patrick Hand, cursive';
  ctx.fillStyle = '#6B5740';
  ctx.fillText(data.iq ? getIQLabel(data.iq) : 'IQ', 270, 225);
  
  // Percentile
  if (data.iq) {
    const pct = iqToPercentile(data.iq);
    ctx.fillStyle = '#A08C6E';
    roundRect(ctx, 200, 240, 140, 28, 14);
    ctx.fill();
    ctx.font = '400 13px Patrick Hand, cursive';
    ctx.fillStyle = '#F5EDD8';
    ctx.fillText('Top ' + formatPercentile(pct), 270, 259);
  }
  
  // Quick stats
  ctx.font = '700 20px Verdana, sans-serif';
  ctx.fillStyle = '#2A2018';
  ctx.fillText(data.questionsAnswered, 130, 310);
  ctx.fillText(IQData.getAccuracy() + '%', 270, 310);
  ctx.fillText(data.bestStreak, 410, 310);
  
  ctx.font = '400 11px Patrick Hand, cursive';
  ctx.fillStyle = '#6B5740';
  ctx.fillText('Answered', 130, 328);
  ctx.fillText('Accuracy', 270, 328);
  ctx.fillText('Best Streak', 410, 328);
  
  // Divider
  ctx.strokeStyle = '#C4AD8A';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(70, 350);
  ctx.lineTo(470, 350);
  ctx.stroke();
  
  // Stats
  const stats = [
    { name: 'Pattern Recognition', color: '#C43820', val: IQData.getStatPercent('patternRecognition') },
    { name: 'Problem Solving', color: '#D96A28', val: IQData.getStatPercent('problemSolving') },
    { name: 'Mental Agility', color: '#4AAA4A', val: IQData.getStatPercent('mentalAgility') },
    { name: 'Memory', color: '#8A5BAF', val: IQData.getStatPercent('memory') },
    { name: 'Verbal Reasoning', color: '#6366F1', val: IQData.getStatPercent('verbalReasoning') },
    { name: 'Common Sense', color: '#2A96B8', val: IQData.getStatPercent('commonSense') }
  ];
  
  let y = 375;
  stats.forEach(stat => {
    ctx.font = '700 10px Nunito, sans-serif';
    ctx.fillStyle = '#6B5740';
    ctx.textAlign = 'left';
    ctx.fillText(stat.name.toUpperCase(), 50, y);
    
    ctx.fillStyle = '#D5C8AD';
    roundRect(ctx, 50, y + 6, 440, 24, 6);
    ctx.fill();
    
    ctx.fillStyle = stat.color;
    const barWidth = Math.max(35, (stat.val / 100) * 440);
    roundRect(ctx, 50, y + 6, barWidth, 24, 6);
    ctx.fill();
    
    ctx.font = '700 12px Verdana, sans-serif';
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'left';
    ctx.fillText(stat.val.toString(), 58, y + 22);
    
    y += 48;
  });
  
  // Footer
  ctx.font = '400 13px Patrick Hand, cursive';
  ctx.fillStyle = '#A08C6E';
  ctx.textAlign = 'center';
  ctx.fillText('IQ Profile', 270, 680);
  
  shareCanvas = canvas;
  
  preview.innerHTML = '';
  preview.appendChild(canvas);
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

async function copyShareImage() {
  if (!shareCanvas) return;
  
  try {
    const blob = await new Promise(resolve => shareCanvas.toBlob(resolve, 'image/png'));
    await navigator.clipboard.write([
      new ClipboardItem({ 'image/png': blob })
    ]);
    showToast('Copied to clipboard!');
  } catch (e) {
    showToast('Copy failed - try download');
  }
}

function downloadShareImage() {
  if (!shareCanvas) return;
  
  const link = document.createElement('a');
  link.download = 'my-iq-profile.png';
  link.href = shareCanvas.toDataURL('image/png');
  link.click();
  showToast('Downloaded!');
}

function confirmReset() {
  if (confirm('Reset all progress? This cannot be undone.')) {
    IQData.reset();
    location.reload();
  }
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

document.getElementById('share-modal').addEventListener('click', (e) => {
  if (e.target.id === 'share-modal') closeShareModal();
});

loadProfile();
</script>
</body>
</html>