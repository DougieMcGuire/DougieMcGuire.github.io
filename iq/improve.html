<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Improve | IQ Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared.css">
  <style>
    .feed-wrap {
      flex: 1;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scroll-behavior: smooth;
    }
    .feed-wrap::-webkit-scrollbar { display: none; }

```
.feed-slide {
  height: 100%;
  min-height: 100%;
  scroll-snap-align: start;
  scroll-snap-stop: always;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  position: relative;
}

.q-card {
  background: var(--card);
  border: 2.5px solid var(--tan-dark);
  border-radius: 28px;
  width: min(400px, calc(100vw - 32px));
  min-height: min(400px, calc(100vh - 200px));
  max-height: calc(100vh - 140px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px 20px;
  gap: 14px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.08);
  position: relative;
  overflow: hidden;
}

.q-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.4) 0%, transparent 70%);
  pointer-events: none;
}

.q-category {
  font-family: 'Patrick Hand', cursive;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 5px 14px;
  border-radius: 20px;
  border: 1.5px solid;
  color: var(--cat-color);
  background: color-mix(in srgb, var(--cat-color) 12%, transparent);
  border-color: var(--cat-color);
}

.q-text {
  font-family: 'Nunito', sans-serif;
  font-size: clamp(15px, 3.2vw, 17px);
  font-weight: 700;
  color: var(--ink);
  text-align: center;
  line-height: 1.45;
  max-width: 95%;
}

.q-sequence {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: center;
  font-family: 'Verdana', sans-serif;
  font-size: clamp(20px, 5vw, 28px);
  font-weight: 700;
  color: var(--ink);
  margin: 6px 0;
}
.q-sequence .sep {
  color: var(--tan-darker);
  font-weight: 400;
  opacity: 0.6;
}
.q-sequence .blank {
  color: var(--tan-dark);
  background: var(--bar-bg);
  padding: 4px 14px;
  border-radius: 10px;
  border: 2px dashed var(--tan-dark);
}

.q-matrix {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 5px;
  width: min(160px, 38vw);
}
.q-cell {
  aspect-ratio: 1/1;
  background: var(--bar-bg);
  border-radius: 8px;
  border: 1.5px solid var(--tan-dark);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Verdana', sans-serif;
  font-size: clamp(14px, 3vw, 18px);
  font-weight: 700;
  color: var(--ink);
}
.q-cell.blank {
  background: rgba(164,140,110,0.1);
  border-style: dashed;
  color: var(--tan-dark);
  font-size: clamp(18px, 4vw, 24px);
}

.q-spatial-display {
  font-size: 64px;
  margin: 12px 0;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.q-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
  margin-top: 8px;
}
.q-options.single-col {
  grid-template-columns: 1fr;
}
.q-opt {
  background: var(--bg);
  border: 2px solid var(--tan-dark);
  border-radius: 12px;
  padding: 12px 10px;
  font-family: 'Nunito', sans-serif;
  font-size: clamp(12px, 2.5vw, 14px);
  font-weight: 700;
  color: var(--ink);
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  line-height: 1.3;
}
.q-opt:hover:not(.answered) { 
  background: var(--tan-dark); 
  color: #fff; 
  transform: scale(1.02); 
}
.q-opt:active:not(.answered) {
  transform: scale(0.98);
}
.q-opt.correct { 
  background: var(--green); 
  border-color: #4AAA4A; 
  color: #fff; 
  animation: pulse 0.3s ease;
}
.q-opt.wrong { 
  background: var(--red); 
  border-color: #a03030; 
  color: #fff;
  animation: shake 0.3s ease;
}
.q-opt.answered {
  pointer-events: none;
}
.q-opt.dim {
  opacity: 0.4;
}
.q-opt.show-correct {
  background: var(--green);
  border-color: #4AAA4A;
  color: #fff;
  opacity: 1 !important;
}

.q-explanation {
  background: rgba(42,32,24,0.06);
  border-radius: 12px;
  padding: 10px 14px;
  font-family: 'Nunito', sans-serif;
  font-size: 12px;
  color: var(--ink-light);
  text-align: center;
  line-height: 1.4;
  max-width: 100%;
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease;
}
.q-explanation.show {
  opacity: 1;
  max-height: 100px;
  margin-top: 8px;
}

.scroll-hint {
  margin-top: 14px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.4s;
  font-family: 'Patrick Hand', cursive;
  font-size: 13px;
  color: var(--ink-light);
}
.scroll-hint.show { opacity: 0.6; }
.scroll-hint svg {
  width: 22px; height: 22px;
  stroke: var(--ink-light); fill: none;
  stroke-width: 2;
  animation: bounce 1.5s ease-in-out infinite;
}

.stats-mini {
  position: fixed;
  top: 12px;
  right: 16px;
  background: var(--card);
  border: 2px solid var(--tan-dark);
  border-radius: 20px;
  padding: 8px 16px;
  display: flex;
  gap: 18px;
  z-index: 50;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
}
.stats-mini-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
}
.stats-mini-val {
  font-family: 'Verdana', sans-serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--ink);
}
.stats-mini-val.calculating {
  font-size: 14px;
  color: var(--ink-light);
}
.stats-mini-label {
  font-family: 'Patrick Hand', cursive;
  font-size: 10px;
  color: var(--ink-light);
}

.onboarding-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  text-align: center;
}
.onboarding-emoji {
  font-size: 64px;
}
.onboarding-title {
  font-family: 'Patrick Hand', cursive;
  font-size: 28px;
  color: var(--ink);
}
.onboarding-text {
  font-family: 'Nunito', sans-serif;
  font-size: 15px;
  color: var(--ink-light);
  line-height: 1.5;
}
.age-display {
  font-family: 'Verdana', sans-serif;
  font-size: 48px;
  font-weight: 700;
  color: var(--ink);
  margin: 10px 0;
}
.age-slider {
  width: 100%;
  margin: 10px 0;
}
.onboarding-btn {
  margin-top: 10px;
  padding: 14px 40px;
  font-size: 16px;
}

@media (max-width: 639px) {
  .stats-mini {
    top: 8px;
    right: 8px;
    padding: 6px 12px;
    gap: 14px;
  }
  .stats-mini-val { font-size: 16px; }
}
```

  </style>
</head>
<body>

<div class="doodle-bg">
  <svg style="left:5%;top:8%;width:120px;height:120px;" viewBox="0 0 100 100">
    <path d="M50 80 C30 80 15 65 15 50 C15 35 28 28 38 30 C40 20 50 15 60 20 C70 10 85 18 85 32 C92 36 90 50 82 55 C80 68 65 80 50 80Z"/>
  </svg>
  <svg style="right:6%;top:12%;width:80px;height:90px;" viewBox="0 0 80 90">
    <circle cx="40" cy="32" r="16"/>
    <path d="M32 48 L32 56 Q32 60 40 60 Q48 60 48 56 L48 48"/>
  </svg>
  <svg style="left:8%;bottom:25%;width:70px;height:70px;" viewBox="0 0 80 80">
    <path d="M10 10 L35 10 C35 10 33 15 33 20 C33 25 38 25 40 20 C42 15 40 10 40 10 L65 10 L65 35 C65 35 60 33 55 33 C50 33 50 38 55 40 C60 42 65 40 65 40 L65 65 L40 65 C40 65 42 60 40 55 C38 50 33 50 33 55 C33 60 35 65 35 65 L10 65 L10 40 C10 40 15 42 20 40 C25 38 25 33 20 33 C15 33 10 35 10 35Z"/>
  </svg>
  <svg style="right:4%;bottom:18%;width:50px;height:75px;" viewBox="0 0 52 82">
    <text x="3" y="62" font-family="serif" font-size="58" stroke="currentColor" fill="none" stroke-width="1.4">?</text>
  </svg>
</div>

<nav>
  <a class="nav-btn active" href="improve.html">
    <svg viewBox="0 0 24 24">
      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
      <polyline points="17 6 23 6 23 12"/>
    </svg>
    Improve
  </a>
  <div class="nav-divider"></div>
  <a class="nav-btn" href="profile.html">
    <svg viewBox="0 0 24 24">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
      <circle cx="12" cy="7" r="4"/>
    </svg>
    Profile
  </a>
</nav>

<div class="stats-mini" id="stats-mini">
  <div class="stats-mini-item">
    <span class="stats-mini-val" id="mini-iq">--</span>
    <span class="stats-mini-label">IQ</span>
  </div>
  <div class="stats-mini-item">
    <span class="stats-mini-val" id="mini-streak">0</span>
    <span class="stats-mini-label"></span>
  </div>
</div>

<div id="app">
  <div class="feed-wrap" id="feed"></div>
</div>

<!-- Streak Popup -->

<div class="streak-popup" id="streak-popup">
  <div class="streak-flame"></div>
  <div class="streak-number" id="streak-number">5</div>
  <div class="streak-label">Streak!</div>
</div>

<!-- Onboarding Modal -->

<div class="modal-overlay" id="onboarding-modal">
  <div class="modal-content">
    <div class="onboarding-content">
      <div class="onboarding-emoji"></div>
      <div class="onboarding-title">Welcome to IQ Profile</div>
      <div class="onboarding-text">
        Train your brain with personalized challenges.<br>
        First, tell us your age so we can tailor the difficulty.
      </div>
      <div class="age-display" id="age-display">25</div>
      <input type="range" class="age-slider" id="age-slider" min="5" max="90" value="25">
      <button class="btn primary onboarding-btn" onclick="completeOnboarding()">
        Let's Go!
      </button>
    </div>
  </div>
</div>

<!-- Toast -->

<div class="toast" id="toast"></div>

<script src="data.js"></script>

<script src="questions.js"></script>

<script>
const feed = document.getElementById('feed');
const miniIQ = document.getElementById('mini-iq');
const miniStreak = document.getElementById('mini-streak');
const streakPopup = document.getElementById('streak-popup');
const streakNumber = document.getElementById('streak-number');
const onboardingModal = document.getElementById('onboarding-modal');
const ageSlider = document.getElementById('age-slider');
const ageDisplay = document.getElementById('age-display');

let slides = [];
let currentSlide = 0;
let answerStartTime = 0;

// Init
function init() {
  // Check onboarding
  if (IQData.needsOnboarding()) {
    onboardingModal.classList.add('show');
  } else {
    startApp();
  }
  
  // Age slider
  ageSlider.addEventListener('input', () => {
    ageDisplay.textContent = ageSlider.value;
  });
}

function completeOnboarding() {
  const age = parseInt(ageSlider.value);
  IQData.setAge(age);
  onboardingModal.classList.remove('show');
  startApp();
}

function startApp() {
  const data = IQData.load();
  QuestionGenerator.setAge(data.age);
  updateStats();
  
  // Generate initial slides
  for (let i = 0; i < 5; i++) {
    addSlide();
  }
  
  // Better scroll handling
  feed.addEventListener('scroll', handleScroll, { passive: true });
  feed.addEventListener('wheel', handleWheel, { passive: false });
  
  // Touch handling for mobile
  let touchStartY = 0;
  feed.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
  }, { passive: true });
}

function handleScroll() {
  const slideH = feed.clientHeight;
  const idx = Math.round(feed.scrollTop / slideH);
  
  if (idx !== currentSlide) {
    currentSlide = idx;
    
    if (idx >= slides.length - 3) {
      for (let i = 0; i < 3; i++) {
        addSlide();
      }
    }
  }
}

// Better mouse wheel scrolling
function handleWheel(e) {
  e.preventDefault();
  
  const slideH = feed.clientHeight;
  const direction = e.deltaY > 0 ? 1 : -1;
  const targetSlide = Math.max(0, Math.min(slides.length - 1, currentSlide + direction));
  
  if (targetSlide !== currentSlide) {
    feed.scrollTo({
      top: targetSlide * slideH,
      behavior: 'smooth'
    });
  }
}

function addSlide() {
  const q = QuestionGenerator.generate();
  const slideIdx = slides.length;
  
  const slide = document.createElement('div');
  slide.className = 'feed-slide';
  slide.innerHTML = renderQuestion(q, slideIdx);
  
  feed.appendChild(slide);
  slides.push({ element: slide, question: q, answered: false });
  
  // Reset answer timer
  answerStartTime = Date.now();
}

function renderQuestion(q, idx) {
  const catClass = 'cat-' + (CATEGORIES[q.category]?.cssClass || 'ps');
  
  let content = '';
  
  switch (q.visual) {
    case 'sequence':
      content = `
        <div class="q-sequence">
          ${q.sequence.map((n, i) => `<span>${n}</span>${i < q.sequence.length - 1 ? '<span class="sep">路</span>' : ''}`).join('')}
          <span class="sep">路</span>
          <span class="blank">?</span>
        </div>
      `;
      break;
      
    case 'letterSequence':
      content = `
        <div class="q-sequence">
          ${q.sequence.map((l, i) => `<span>${l}</span>${i < q.sequence.length - 1 ? '<span class="sep">路</span>' : ''}`).join('')}
          <span class="sep">路</span>
          <span class="blank">?</span>
        </div>
      `;
      break;
      
    case 'matrix':
      content = `
        <div class="q-matrix">
          ${q.grid.map(cell => `<div class="q-cell${cell === '?' ? ' blank' : ''}">${cell}</div>`).join('')}
        </div>
      `;
      break;
      
    case 'spatial':
      content = `<div class="q-spatial-display">${q.startShape}</div>`;
      break;
      
    case 'analogy':
      // Question text contains the analogy
      break;
      
    case 'emotional':
    case 'options':
    default:
      break;
  }

  const isLongOptions = q.options.some(o => o.length > 28);
  const optionsClass = isLongOptions ? 'q-options single-col' : 'q-options';
  
  const optionsHTML = `
    <div class="${optionsClass}" data-idx="${idx}" data-answer="${q.answer}" data-cat="${q.category}" data-diff="${q.difficulty}">
      ${q.options.map(opt => `
        <button class="q-opt" data-val="${opt}" onclick="handleAnswer(this)">${opt}</button>
      `).join('')}
    </div>
  `;

  return `
    <div class="q-card">
      <div class="q-category ${catClass}">${q.categoryLabel}</div>
      <div class="q-text">${q.question}</div>
      ${content}
      ${optionsHTML}
      <div class="q-explanation" id="explain-${idx}">${q.explanation || ''}</div>
    </div>
    <div class="scroll-hint" id="hint-${idx}">
      <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
      Swipe for next
    </div>
  `;
}

function handleAnswer(btn) {
  const opts = btn.closest('.q-options');
  if (opts.dataset.locked) return;
  opts.dataset.locked = '1';

  const idx = parseInt(opts.dataset.idx);
  const correct = opts.dataset.answer;
  const category = opts.dataset.cat;
  const difficulty = parseFloat(opts.dataset.diff);
  const isCorrect = btn.dataset.val === correct;
  const responseTime = Date.now() - answerStartTime;

  // Visual feedback
  opts.querySelectorAll('.q-opt').forEach(o => {
    o.classList.add('answered');
    if (o.dataset.val === correct) {
      o.classList.add(isCorrect ? 'correct' : 'show-correct');
    } else if (o === btn && !isCorrect) {
      o.classList.add('wrong');
    } else {
      o.classList.add('dim');
    }
  });

  // Update stats
  const data = IQData.recordAnswer(category, isCorrect, difficulty, responseTime);
  
  // Show explanation
  const explainEl = document.getElementById(`explain-${idx}`);
  if (explainEl) {
    setTimeout(() => explainEl.classList.add('show'), 300);
  }

  // Check streak milestone
  if (isCorrect && data.streak > 0 && data.streak % 5 === 0) {
    showStreakPopup(data.streak);
  }

  // Update UI
  updateStats();

  // Show scroll hint
  setTimeout(() => {
    const hint = document.getElementById(`hint-${idx}`);
    if (hint) hint.classList.add('show');
  }, 600);

  slides[idx].answered = true;
  answerStartTime = Date.now();
}

function updateStats() {
  const data = IQData.load();
  
  if (data.iq) {
    miniIQ.textContent = data.iq;
    miniIQ.classList.remove('calculating');
  } else {
    miniIQ.textContent = '...';
    miniIQ.classList.add('calculating');
  }
  
  miniStreak.textContent = data.streak;
}

function showStreakPopup(streak) {
  streakNumber.textContent = streak;
  streakPopup.classList.add('show');
  
  setTimeout(() => {
    streakPopup.classList.remove('show');
  }, 2500);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

init();
</script>

</body>
</html>