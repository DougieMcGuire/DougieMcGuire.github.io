<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Improve | IQ Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared.css">
  <style>
    /* ─── IMPROVE PAGE SPECIFIC ─── */
    .feed-wrap {
      flex: 1;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .feed-wrap::-webkit-scrollbar { display: none; }

    .feed-slide {
      height: 100%;
      min-height: 100%;
      scroll-snap-align: start;
      scroll-snap-stop: always;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px 20px 20px;
      position: relative;
    }

    /* Question card */
    .q-card {
      background: var(--card);
      border: 2px solid var(--tan-dark);
      border-radius: 28px;
      width: min(420px, calc(100vw - 40px));
      min-height: min(420px, calc(100vw - 40px));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 28px 24px;
      gap: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.09);
      position: relative;
      overflow: hidden;
    }

    .q-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.35) 0%, transparent 70%);
      pointer-events: none;
    }

    .q-category {
      font-family: 'Patrick Hand', cursive;
      font-size: 11px;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      padding: 4px 14px;
      border-radius: 20px;
      border: 1px solid;
      transition: all 0.3s;
    }

    .q-category.cat-ps  { color: #D96A28; background: rgba(217,106,40,0.12); border-color: #D96A28; }
    .q-category.cat-mem { color: #8A5BAF; background: rgba(138,91,175,0.12); border-color: #8A5BAF; }
    .q-category.cat-pr  { color: #C43820; background: rgba(196,56,32,0.12); border-color: #C43820; }
    .q-category.cat-cs  { color: #2A96B8; background: rgba(42,150,184,0.12); border-color: #2A96B8; }
    .q-category.cat-ma  { color: #4AAA4A; background: rgba(74,170,74,0.12); border-color: #4AAA4A; }
    .q-category.cat-ei  { color: #C44878; background: rgba(196,72,120,0.12); border-color: #C44878; }

    .q-text {
      font-family: 'Nunito', sans-serif;
      font-size: clamp(15px, 3.5vw, 18px);
      font-weight: 700;
      color: var(--ink);
      text-align: center;
      line-height: 1.5;
      max-width: 95%;
    }

    /* Sequence display */
    .q-sequence {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      font-family: 'Verdana', sans-serif;
      font-size: clamp(18px, 4vw, 24px);
      font-weight: 700;
      color: var(--ink);
      margin: 8px 0;
    }
    .q-sequence .sep {
      color: var(--tan-darker);
      font-weight: 400;
    }
    .q-sequence .blank {
      color: var(--tan-dark);
      background: var(--bar-bg);
      padding: 4px 12px;
      border-radius: 8px;
      border: 2px dashed var(--tan-dark);
    }

    /* Matrix grid */
    .q-matrix {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      width: min(180px, 40vw);
    }
    .q-cell {
      aspect-ratio: 1/1;
      background: var(--bar-bg);
      border-radius: 8px;
      border: 1.5px solid var(--tan-dark);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Verdana', sans-serif;
      font-size: clamp(14px, 3vw, 18px);
      font-weight: 700;
      color: var(--ink);
    }
    .q-cell.blank {
      background: rgba(164,140,110,0.08);
      border-style: dashed;
      color: var(--tan-dark);
      font-size: clamp(20px, 4vw, 26px);
    }

    /* Memory pattern display */
    .q-memory-display {
      display: flex;
      gap: 8px;
      font-size: 28px;
      padding: 12px 20px;
      background: var(--bar-bg);
      border-radius: 16px;
      border: 2px solid var(--tan-dark);
    }
    .q-memory-display.hidden span {
      filter: blur(8px);
    }

    /* Options */
    .q-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      width: 100%;
      margin-top: 8px;
    }
    .q-options.single-col {
      grid-template-columns: 1fr;
    }
    .q-opt {
      background: var(--bg);
      border: 2px solid var(--tan-dark);
      border-radius: 12px;
      padding: 12px 10px;
      font-family: 'Nunito', sans-serif;
      font-size: clamp(12px, 2.5vw, 14px);
      font-weight: 700;
      color: var(--ink);
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
      line-height: 1.3;
    }
    .q-opt:hover:not(.answered) { 
      background: var(--tan-dark); 
      color: #fff; 
      transform: scale(1.02); 
    }
    .q-opt.correct { 
      background: var(--green); 
      border-color: #4AAA4A; 
      color: #fff; 
      transform: scale(1.03);
    }
    .q-opt.wrong { 
      background: var(--red); 
      border-color: #a0301a; 
      color: #fff;
      opacity: 0.8;
    }
    .q-opt.answered {
      pointer-events: none;
    }
    .q-opt.dim {
      opacity: 0.5;
    }

    /* Result feedback */
    .q-result {
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      color: var(--ink-light);
      text-align: center;
      margin-top: 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .q-result.show {
      opacity: 1;
    }

    /* Scroll hint */
    .scroll-hint {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      color: var(--ink-light);
    }
    .scroll-hint.show {
      opacity: 0.6;
    }
    .scroll-hint svg {
      width: 20px; height: 20px;
      stroke: var(--ink-light); fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
      animation: bounce 1.6s ease-in-out infinite;
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50%     { transform: translateY(5px); }
    }

    /* Progress indicator */
    .progress-bar {
      position: fixed;
      top: 0;
      left: var(--side-nav-w);
      right: 0;
      height: 3px;
      background: var(--bar-bg);
      z-index: 50;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #82CC82);
      width: 0%;
      transition: width 0.3s ease;
    }
    @media (max-width: 639px) {
      .progress-bar { left: 0; }
    }

    /* Stats overlay */
    .stats-mini {
      position: fixed;
      top: 12px;
      right: 16px;
      background: var(--card);
      border: 2px solid var(--tan-dark);
      border-radius: 20px;
      padding: 8px 16px;
      display: flex;
      gap: 16px;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .stats-mini-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .stats-mini-val {
      font-family: 'Verdana', sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--ink);
    }
    .stats-mini-label {
      font-family: 'Patrick Hand', cursive;
      font-size: 10px;
      color: var(--ink-light);
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>

  <!-- DOODLE BG -->
  <div class="doodle-bg">
    <svg style="left:6%;top:6%;width:140px;height:140px;" viewBox="0 0 100 100">
      <path d="M50 80 C30 80 15 65 15 50 C15 35 28 28 38 30 C40 20 50 15 60 20 C70 10 85 18 85 32 C92 36 90 50 82 55 C80 68 65 80 50 80Z"/>
    </svg>
    <svg style="right:8%;top:10%;width:100px;height:110px;" viewBox="0 0 80 90">
      <circle cx="40" cy="32" r="16"/>
      <path d="M32 48 L32 56 Q32 60 40 60 Q48 60 48 56 L48 48"/>
    </svg>
    <svg style="left:3%;top:43%;width:140px;height:52px;" viewBox="0 0 135 48">
      <text x="4" y="38" font-family="serif" font-size="32" stroke="currentColor" fill="none" stroke-width="1.3">IQ = ?</text>
    </svg>
    <svg style="right:4%;top:48%;width:90px;height:90px;" viewBox="0 0 80 80">
      <path d="M10 10 L35 10 C35 10 33 15 33 20 C33 25 38 25 40 20 C42 15 40 10 40 10 L65 10 L65 35 C65 35 60 33 55 33 C50 33 50 38 55 40 C60 42 65 40 65 40 L65 65 L40 65 C40 65 42 60 40 55 C38 50 33 50 33 55 C33 60 35 65 35 65 L10 65 L10 40 C10 40 15 42 20 40 C25 38 25 33 20 33 C15 33 10 35 10 35Z"/>
    </svg>
    <svg style="left:55%;top:3%;width:60px;height:60px;" viewBox="0 0 56 56">
      <polygon points="28,4 31,19 46,19 34,28 38,43 28,33 18,43 22,28 10,19 25,19"/>
    </svg>
    <svg style="right:3%;bottom:22%;width:60px;height:90px;" viewBox="0 0 52 82">
      <text x="3" y="62" font-family="serif" font-size="58" stroke="currentColor" fill="none" stroke-width="1.4">?</text>
    </svg>
  </div>

  <!-- NAV -->
  <nav>
    <a class="nav-btn active" href="improve.html">
      <svg viewBox="0 0 24 24">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
        <polyline points="17 6 23 6 23 12"/>
      </svg>
      Improve
    </a>
    <div class="nav-divider"></div>
    <a class="nav-btn" href="profile.html">
      <svg viewBox="0 0 24 24">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Profile
    </a>
  </nav>

  <!-- Progress bar -->
  <div class="progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
  </div>

  <!-- Mini stats -->
  <div class="stats-mini">
    <div class="stats-mini-item">
      <span class="stats-mini-val" id="mini-iq">80</span>
      <span class="stats-mini-label">IQ</span>
    </div>
    <div class="stats-mini-item">
      <span class="stats-mini-val" id="mini-streak">0</span>
      <span class="stats-mini-label">Streak</span>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <div class="feed-wrap" id="feed"></div>
  </div>

  <script src="data.js"></script>
  <script src="questions.js"></script>
  <script>
    const feed = document.getElementById('feed');
    const progressFill = document.getElementById('progress-fill');
    const miniIQ = document.getElementById('mini-iq');
    const miniStreak = document.getElementById('mini-streak');
    
    let slides = [];
    let currentSlide = 0;
    let streak = 0;
    let sessionCorrect = 0;
    let sessionTotal = 0;

    // Initialize
    function init() {
      const data = IQData.load();
      miniIQ.textContent = data.iq;
      
      // Generate initial slides
      for (let i = 0; i < 5; i++) {
        addSlide();
      }
      
      // Set up infinite scroll
      feed.addEventListener('scroll', handleScroll, { passive: true });
      
      // Update progress
      updateProgress();
    }

    // Handle scroll
    function handleScroll() {
      const slideH = feed.clientHeight;
      const idx = Math.round(feed.scrollTop / slideH);
      
      if (idx !== currentSlide) {
        currentSlide = idx;
        
        // Add more slides if needed
        if (idx >= slides.length - 3) {
          for (let i = 0; i < 3; i++) {
            addSlide();
          }
        }
        
        updateProgress();
      }
    }

    // Add a new slide
    function addSlide() {
      const q = QuestionGenerator.generate();
      const slideIdx = slides.length;
      
      const slide = document.createElement('div');
      slide.className = 'feed-slide';
      slide.innerHTML = renderQuestion(q, slideIdx);
      
      feed.appendChild(slide);
      slides.push({ element: slide, question: q, answered: false });
      
      // Handle memory questions
      if (q.visual === 'memory') {
        setTimeout(() => {
          const display = slide.querySelector('.q-memory-display');
          if (display) display.classList.add('hidden');
        }, 2000);
      }
    }

    // Render question HTML
    function renderQuestion(q, idx) {
      const catClass = 'cat-' + CATEGORIES[q.category].cssClass;
      
      let content = '';
      
      // Visual content based on type
      switch (q.visual) {
        case 'sequence':
          content = `
            <div class="q-sequence">
              ${q.sequence.map((n, i) => `<span>${n}</span>${i < q.sequence.length - 1 ? '<span class="sep">·</span>' : ''}`).join('')}
              <span class="sep">·</span>
              <span class="blank">?</span>
            </div>
          `;
          break;
          
        case 'wordSequence':
          content = `
            <div class="q-sequence">
              ${q.sequence.map((w, i) => `<span>${w}</span>${i < q.sequence.length - 1 ? '<span class="sep">→</span>' : ''}`).join('')}
              <span class="sep">→</span>
              <span class="blank">?</span>
            </div>
          `;
          break;
          
        case 'matrix':
          content = `
            <div class="q-matrix">
              ${q.grid.map(cell => `<div class="q-cell${cell === '?' ? ' blank' : ''}">${cell}</div>`).join('')}
            </div>
          `;
          break;
          
        case 'memory':
          content = `
            <div class="q-memory-display">
              ${q.pattern.map(c => `<span>${c}</span>`).join('')}
            </div>
            <div style="font-family:'Patrick Hand',cursive;font-size:12px;color:var(--ink-light);margin-top:4px;">
              Memorize the pattern!
            </div>
          `;
          break;
          
        case 'emotional':
          // No extra visual, just longer options
          break;
          
        default:
          // Just options
          break;
      }

      // Options grid
      const isLongOptions = q.options.some(o => o.length > 25);
      const optionsClass = isLongOptions ? 'q-options single-col' : 'q-options';
      
      const optionsHTML = `
        <div class="${optionsClass}" data-idx="${idx}" data-answer="${q.answer}" data-cat="${q.category}" data-diff="${q.difficulty}">
          ${q.options.map(opt => `
            <button class="q-opt" data-val="${opt}" onclick="handleAnswer(this)">${opt}</button>
          `).join('')}
        </div>
      `;

      return `
        <div class="q-card">
          <div class="q-category ${catClass}">${q.categoryLabel}</div>
          <div class="q-text">${q.question}</div>
          ${content}
          ${optionsHTML}
          <div class="q-result" id="result-${idx}"></div>
        </div>
        <div class="scroll-hint" id="hint-${idx}">
          <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
          Swipe for next
        </div>
      `;
    }

    // Handle answer
    function handleAnswer(btn) {
      const opts = btn.closest('.q-options');
      if (opts.dataset.locked) return;
      opts.dataset.locked = '1';

      const idx = parseInt(opts.dataset.idx);
      const correct = opts.dataset.answer;
      const category = opts.dataset.cat;
      const difficulty = parseFloat(opts.dataset.diff);
      const isCorrect = btn.dataset.val === correct;

      // Visual feedback
      opts.querySelectorAll('.q-opt').forEach(o => {
        o.classList.add('answered');
        if (o.dataset.val === correct) {
          o.classList.add('correct');
        } else if (o === btn && !isCorrect) {
          o.classList.add('wrong');
        } else {
          o.classList.add('dim');
        }
      });

      // Update stats
      const data = IQData.recordAnswer(category, isCorrect, difficulty);
      
      // Update session stats
      sessionTotal++;
      if (isCorrect) {
        sessionCorrect++;
        streak++;
      } else {
        streak = 0;
      }

      // Update UI
      miniIQ.textContent = data.iq;
      miniStreak.textContent = streak;

      // Show result
      const result = document.getElementById(`result-${idx}`);
      if (isCorrect) {
        result.textContent = streak > 1 ? `✓ Correct! ${streak} streak` : '✓ Correct!';
        result.style.color = 'var(--green)';
      } else {
        result.textContent = `✗ Answer: ${correct}`;
        result.style.color = 'var(--red)';
      }
      result.classList.add('show');

      // Show scroll hint
      setTimeout(() => {
        const hint = document.getElementById(`hint-${idx}`);
        if (hint) hint.classList.add('show');
      }, 500);

      // Mark slide as answered
      slides[idx].answered = true;
      
      updateProgress();
    }

    // Update progress bar
    function updateProgress() {
      const answeredCount = slides.filter(s => s.answered).length;
      const progress = Math.min(100, (answeredCount / 10) * 100);
      progressFill.style.width = progress + '%';
    }

    // Start
    init();
  </script>
</body>
</html>