<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Recap</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }

        .slide {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.8s ease;
        }

        .slide.active {
            opacity: 1;
            transform: translateY(0);
        }

        .slide-content {
            max-width: 900px;
            text-align: center;
            z-index: 2;
            position: relative;
        }

        .intro-slide {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        .intro-slide h1 {
            font-size: 6rem;
            font-weight: 900;
            margin-bottom: 30px;
            letter-spacing: -3px;
            background: linear-gradient(45deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInUp 1s ease-out;
        }

        .intro-slide p {
            font-size: 1.5rem;
            color: #888;
            margin-bottom: 50px;
            font-weight: 300;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        .username-input {
            width: 100%;
            max-width: 500px;
            padding: 25px 30px;
            font-size: 1.3rem;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 60px;
            color: #fff;
            outline: none;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            animation: fadeInUp 1s ease-out 0.6s both;
        }

        .username-input::placeholder {
            color: #666;
        }

        .username-input:focus {
            border-color: #fff;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.08);
        }

        .start-btn {
            margin-top: 30px;
            padding: 20px 50px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeInUp 1s ease-out 0.9s both;
        }

        .start-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255,255,255,0.3);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recap-slide {
            background: #111;
            flex-direction: column;
        }

        .slide-number {
            position: absolute;
            top: 40px;
            right: 40px;
            font-size: 1rem;
            color: #666;
            font-weight: 600;
        }

        .slide-title {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 40px;
            letter-spacing: -2px;
        }

        .slide-subtitle {
            font-size: 1.5rem;
            color: #888;
            margin-bottom: 50px;
            font-weight: 400;
        }

        .big-stat {
            font-size: 8rem;
            font-weight: 900;
            line-height: 0.8;
            margin: 40px 0;
            background: linear-gradient(45deg, #fff, #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 1.8rem;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .comparison-text {
            font-size: 1.3rem;
            color: #bbb;
            margin-top: 30px;
            line-height: 1.5;
        }

        .game-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .game-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .game-card:hover {
            transform: translateY(-10px);
            background: rgba(255,255,255,0.05);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .game-image {
            width: 100%;
            height: 150px;
            border-radius: 15px;
            object-fit: cover;
            margin-bottom: 20px;
            background: #222;
        }

        .game-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .game-stat {
            color: #888;
            font-size: 0.9rem;
        }

        .navigation {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .nav-btn {
            padding: 15px 25px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #fff;
            transition: width 0.3s ease;
            z-index: 100;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-status {
            color: #888;
            font-size: 1rem;
        }

        .avatar-showcase {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .avatar-card {
            text-align: center;
        }

        .avatar-img {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 3px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .avatar-img:hover {
            transform: scale(1.05);
            border-color: rgba(255,255,255,0.3);
        }

        .timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 50px 0;
            padding: 0 50px;
        }

        .timeline-item {
            text-align: center;
            flex: 1;
        }

        .timeline-year {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 10px;
        }

        .timeline-event {
            font-size: 1rem;
            color: #888;
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .friend-card {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .friend-card:hover {
            background: rgba(255,255,255,0.06);
            transform: translateY(-5px);
        }

        .friend-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .error-slide {
            background: #1a0a0a;
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .intro-slide h1 { font-size: 3.5rem; }
            .slide-title { font-size: 2.5rem; }
            .big-stat { font-size: 5rem; }
            .timeline { flex-direction: column; gap: 30px; }
            .avatar-showcase { flex-direction: column; align-items: center; }
        }

        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: float 8s linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(100px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>
    
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Generating Your Roblox Recap...</div>
        <div class="loading-status" id="loadingStatus">Searching for user...</div>
    </div>

    <!-- Slide 1: Intro -->
    <div class="slide intro-slide active" id="slide0">
        <div class="particles" id="particles"></div>
        <div class="slide-content">
            <h1>Roblox Recap</h1>
            <p>Your journey through the metaverse, visualized</p>
            <input type="text" class="username-input" id="usernameInput" placeholder="Enter your username">
            <br>
            <button class="start-btn" id="startBtn">Generate My Recap</button>
        </div>
    </div>

    <!-- Slide 2: Welcome -->
    <div class="slide recap-slide" id="slide1">
        <div class="slide-number">1/12</div>
        <div class="slide-content">
            <h2 class="slide-title">Welcome back,</h2>
            <div class="big-stat" id="displayName">Loading...</div>
            <p class="slide-subtitle">Let's dive into your Roblox story</p>
        </div>
    </div>

    <!-- Slide 3: Account Age -->
    <div class="slide recap-slide" id="slide2">
        <div class="slide-number">2/12</div>
        <div class="slide-content">
            <h2 class="slide-title">You've been building</h2>
            <div class="big-stat" id="accountAge">0</div>
            <p class="stat-label">Days in Roblox</p>
            <p class="comparison-text" id="ageComparison">Loading comparison...</p>
        </div>
    </div>

    <!-- Slide 4: Join Era -->
    <div class="slide recap-slide" id="slide3">
        <div class="slide-number">3/12</div>
        <div class="slide-content">
            <h2 class="slide-title">You joined during</h2>
            <div class="big-stat" id="joinEra">2019</div>
            <p class="stat-label">The Golden Era</p>
            <div class="timeline" id="timeline">
                <!-- Timeline will be populated -->
            </div>
        </div>
    </div>

    <!-- Slide 5: Avatar Evolution -->
    <div class="slide recap-slide" id="slide4">
        <div class="slide-number">4/12</div>
        <div class="slide-content">
            <h2 class="slide-title">Your Avatar Journey</h2>
            <p class="slide-subtitle">From noob to pro</p>
            <div class="avatar-showcase">
                <div class="avatar-card">
                    <img class="avatar-img" id="headshot" src="" alt="Your Avatar">
                    <p style="color: #888;">Current Look</p>
                </div>
                <div class="avatar-card">
                    <img class="avatar-img" id="fullbody" src="" alt="Full Avatar">
                    <p style="color: #888;">Full Body</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 6: Social Stats -->
    <div class="slide recap-slide" id="slide5">
        <div class="slide-number">5/12</div>
        <div class="slide-content">
            <h2 class="slide-title">You've connected with</h2>
            <div class="big-stat" id="totalConnections">0</div>
            <p class="stat-label">Friends & Followers</p>
            <p class="comparison-text" id="socialComparison">Loading...</p>
        </div>
    </div>

    <!-- Slide 7: Games Created -->
    <div class="slide recap-slide" id="slide6">
        <div class="slide-number">6/12</div>
        <div class="slide-content">
            <h2 class="slide-title">You've created</h2>
            <div class="big-stat" id="gamesCreated">0</div>
            <p class="stat-label">Experiences</p>
            <div class="game-showcase" id="topGames">
                <!-- Games will be populated -->
            </div>
        </div>
    </div>

    <!-- Slide 8: Badges Earned -->
    <div class="slide recap-slide" id="slide7">
        <div class="slide-number">7/12</div>
        <div class="slide-content">
            <h2 class="slide-title">You've earned</h2>
            <div class="big-stat" id="badgesEarned">0</div>
            <p class="stat-label">Badges</p>
            <p class="comparison-text" id="badgeComparison">Loading...</p>
        </div>
    </div>

    <!-- Slide 9: Groups -->
    <div class="slide recap-slide" id="slide8">
        <div class="slide-number">8/12</div>
        <div class="slide-content">
            <h2 class="slide-title">You're part of</h2>
            <div class="big-stat" id="groupCount">0</div>
            <p class="stat-label">Communities</p>
            <div class="game-showcase" id="topGroups">
                <!-- Groups will be populated -->
            </div>
        </div>
    </div>

    <!-- Slide 10: Username Evolution -->
    <div class="slide recap-slide" id="slide9">
        <div class="slide-number">9/12</div>
        <div class="slide-content">
            <h2 class="slide-title">Your Identity Evolution</h2>
            <div class="timeline" id="usernameTimeline">
                <!-- Username history -->
            </div>
        </div>
    </div>

    <!-- Slide 11: Your Roblox DNA -->
    <div class="slide recap-slide" id="slide10">
        <div class="slide-number">10/12</div>
        <div class="slide-content">
            <h2 class="slide-title">Your Roblox DNA</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin: 40px 0;">
                <div>
                    <div class="big-stat" id="creativityScore">85</div>
                    <p class="stat-label">Creativity Score</p>
                </div>
                <div>
                    <div class="big-stat" id="socialScore">92</div>
                    <p class="stat-label">Social Score</p>
                </div>
            </div>
            <p class="comparison-text" id="dnaExplanation">Loading your unique profile...</p>
        </div>
    </div>

    <!-- Slide 12: Year in Review -->
    <div class="slide recap-slide" id="slide11">
        <div class="slide-number">11/12</div>
        <div class="slide-content">
            <h2 class="slide-title">This Year's Highlights</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin: 40px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 800; margin-bottom: 10px;" id="newBadges">0</div>
                    <p style="color: #888;">New Badges</p>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 800; margin-bottom: 10px;" id="newFriends">0</div>
                    <p style="color: #888;">New Friends</p>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 800; margin-bottom: 10px;" id="newGames">0</div>
                    <p style="color: #888;">Games Created</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 13: Thank You -->
    <div class="slide recap-slide" id="slide12">
        <div class="slide-number">12/12</div>
        <div class="slide-content">
            <h2 class="slide-title">Thanks for an epic year</h2>
            <p class="slide-subtitle">Here's to many more adventures in the metaverse</p>
            <div style="margin: 50px 0;">
                <button class="start-btn" onclick="shareRecap()">Share Your Recap</button>
                <button class="start-btn" onclick="startOver()" style="margin-left: 20px; background: transparent; border: 2px solid #fff;">Start Over</button>
            </div>
        </div>
    </div>

    <div class="navigation">
        <button class="nav-btn" id="prevBtn" onclick="prevSlide()">← Previous</button>
        <button class="nav-btn" id="nextBtn" onclick="nextSlide()">Next →</button>
    </div>

    <script>
        const PROXY = 'https://corsproxy.io/?';
        const API_BASE = 'https://users.roblox.com/v1';
        const THUMBNAILS_API = 'https://thumbnails.roblox.com/v1';
        const FRIENDS_API = 'https://friends.roblox.com/v1';
        const GAMES_API = 'https://games.roblox.com/v2';
        const PRESENCE_API = 'https://presence.roblox.com/v1';
        const BADGES_API = 'https://badges.roblox.com/v1';
        const GROUPS_API = 'https://groups.roblox.com/v1';

        let currentSlide = 0;
        let totalSlides = 13;
        let userData = {};
        let isGenerating = false;

        async function fetchWithCORS(url, options = {}) {
            const proxyUrl = PROXY + encodeURIComponent(url);
            return fetch(proxyUrl, options);
        }

        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (8 + Math.random() * 4) + 's';
                container.appendChild(particle);
            }
        }

        async function generateRecap() {
            console.log('generateRecap called');
            
            if (isGenerating) {
                console.log('Already generating, returning');
                return;
            }
            
            isGenerating = true;

            const username = document.getElementById('usernameInput').value.trim();
            console.log('Username:', username);
            
            if (!username) {
                alert('Please enter a username');
                isGenerating = false;
                return;
            }

            showLoading(true);
            
            try {
                // Step 1: Search user
                updateLoadingStatus('Searching for user...');
                console.log('Searching for user...');
                
                const searchUrl = `${API_BASE}/users/search?keyword=${encodeURIComponent(username)}`;
                console.log('Search URL:', searchUrl);
                
                const searchResponse = await fetchWithCORS(searchUrl);
                const searchData = await searchResponse.json();
                
                console.log('Search response:', searchData);
                
                if (!searchData.data || searchData.data.length === 0) {
                    showError('User not found');
                    return;
                }

                const exactMatch = searchData.data.find(user => 
                    user.name.toLowerCase() === username.toLowerCase()
                );

                if (!exactMatch) {
                    showError('Exact username match not found');
                    return;
                }

                console.log('Found user:', exactMatch);

                // Step 2: Gather all data
                updateLoadingStatus('Gathering profile data...');
                const userDetails = await fetchUserDetails(exactMatch.id);
                console.log('User details:', userDetails);
                
                updateLoadingStatus('Loading avatars...');
                const [avatar, fullBody] = await Promise.all([
                    fetchAvatar(exactMatch.id),
                    fetchFullBodyAvatar(exactMatch.id)
                ]);
                console.log('Avatars loaded');

                updateLoadingStatus('Analyzing social connections...');
                const [friendsCount, followersCount, followingCount] = await Promise.all([
                    fetchFriendsCount(exactMatch.id),
                    fetchFollowersCount(exactMatch.id),
                    fetchFollowingCount(exactMatch.id)
                ]);
                console.log('Social data loaded');

                updateLoadingStatus('Scanning games and badges...');
                const [games, badges, groups] = await Promise.all([
                    fetchUserGames(exactMatch.id),
                    fetchUserBadges(exactMatch.id),
                    fetchUserGroups(exactMatch.id)
                ]);
                console.log('Games, badges, groups loaded');

                updateLoadingStatus('Calculating your Roblox DNA...');
                
                // Store all data
                userData = {
                    basic: exactMatch,
                    details: userDetails,
                    avatar,
                    fullBody,
                    friendsCount,
                    followersCount,
                    followingCount,
                    games,
                    badges,
                    groups
                };

                console.log('All user data:', userData);

                updateLoadingStatus('Finalizing your recap...');
                await new Promise(resolve => setTimeout(resolve, 1000));

                populateRecapData();
                showLoading(false);
                nextSlide();

            } catch (error) {
                console.error('Recap generation error:', error);
                showError('Failed to generate recap. Try again.');
            } finally {
                isGenerating = false;
            }
        }

        function populateRecapData() {
            const { basic, details, avatar, fullBody, friendsCount, followersCount, followingCount, games, badges, groups } = userData;

            // Calculate stats
            const joinDate = new Date(details.created);
            const accountAge = Math.floor((Date.now() - joinDate) / (1000 * 60 * 60 * 24));
            const joinYear = joinDate.getFullYear();
            const totalConnections = friendsCount + followersCount;

            // Populate slides
            document.getElementById('displayName').textContent = basic.displayName;
            document.getElementById('accountAge').textContent = accountAge.toLocaleString();
            document.getElementById('joinEra').textContent = joinYear;
            document.getElementById('totalConnections').textContent = totalConnections.toLocaleString();
            document.getElementById('gamesCreated').textContent = games.length;
            document.getElementById('badgesEarned').textContent = badges.length;
            document.getElementById('groupCount').textContent = groups.length;

            // Set avatars
            document.getElementById('headshot').src = avatar || 'https://via.placeholder.com/200x200/333/fff?text=No+Avatar';
            document.getElementById('fullbody').src = fullBody || 'https://via.placeholder.com/200x250/333/fff?text=No+Avatar';

            // Age comparison
            const avgAccountAge = 2190; // ~6 years average based on research
            const agePercentile = accountAge > avgAccountAge ? 85 : 35;
            document.getElementById('ageComparison').textContent = 
                `You're older than ${agePercentile}% of Roblox users. ${accountAge > avgAccountAge ? 'You\'re a veteran!' : 'Still plenty of adventures ahead!'}`;

            // Social comparison
            const avgConnections = 250;
            const socialPercentile = totalConnections > avgConnections ? 75 : 45;
            document.getElementById('socialComparison').textContent = 
                `You're more social than ${socialPercentile}% of users. ${totalConnections > 1000 ? 'You\'re a social butterfly!' : 'Your network is growing!'}`;

            // Badge comparison
            const avgBadges = 45;
            const badgePercentile = badges.length > avgBadges ? 80 : 40;
            document.getElementById('badgeComparison').textContent = 
                `You've earned more badges than ${badgePercentile}% of players. ${badges.length > 100 ? 'Achievement hunter!' : 'Keep collecting!'}`;

            // Populate games
            const topGamesEl = document.getElementById('topGames');
            if (games.length > 0) {
                topGamesEl.innerHTML = games.slice(0, 6).map(game => `
                    <div class="game-card">
                        <img class="game-image" src="https://assetdelivery.roblox.com/v1/asset/?id=${game.id}" 
                             alt="${game.name}" onerror="this.src='https://via.placeholder.com/250x150/333/fff?text=GAME'">
                        <div class="game-name">${game.name}</div>
                        <div class="game-stat">${new Date(game.created).getFullYear()}</div>
                    </div>
                `).join('');
            } else {
                topGamesEl.innerHTML = '<p style="color: #666; font-size: 1.2rem;">No games created yet - your next masterpiece awaits!</p>';
            }

            // Populate groups
            const topGroupsEl = document.getElementById('topGroups');
            if (groups.length > 0) {
                topGroupsEl.innerHTML = groups.slice(0, 6).map(groupData => `
                    <div class="game-card">
                        <img class="game-image" src="https://via.placeholder.com/250x150/333/fff?text=${encodeURIComponent(groupData.group.name.charAt(0))}" 
                             alt="${groupData.group.name}">
                        <div class="game-name">${groupData.group.name}</div>
                        <div class="game-stat">${groupData.role.name}</div>
